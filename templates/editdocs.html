<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Syngrafias | Collaborator</title>
		<link rel="stylesheet" href="{{ url_for('static', filename='css3/fontsome.css') }}" />
        <link rel="stylesheet" href="{{ url_for('static', filename='css3/adminlte.css') }}" />
        <link rel="stylesheet" href="{{ url_for('static', filename='css3/jquery-ui.css') }}" />
		<link rel="stylesheet" href="{{ url_for('static', filename='css3/toastr.css') }}" />
		<script src="{{ url_for('static', filename='jscn/jquery.min.js') }}"></script>
    	<script src="{{ url_for('static', filename='jscn/bootstrap.bundle.js') }}"></script>
    	<script src="{{ url_for('static', filename='jscn/adminlte.js') }}"></script>
		<script src="{{ url_for('static', filename='jscn/jquery-ui.js') }}"></script>
		<script src="{{ url_for('static', filename='jscn/toastr.min.js') }}"></script>
		<script src="{{ url_for('static', filename='jscn/bs-custom-file-input.js') }}"></script>
		<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
		<style>
            .normelem{
                font-family: "Inter", sans-serif;
                font-weight: 400;
            }
            .headelem {
                font-family: "Inter", sans-serif;
                font-weight: 700;
            }
			body {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
		</style>
	</head>
	<body class="hold-transition sidebar-mini text-sm layout-navbar-fixed layout-footer-fixed" onload="$('#givename').modal('show'); StartRunningTime(); document.getElementById('username').value = ''; document.getElementById('roomiden').value = ''; document.getElementById('ttletext').value = ''; $('#openfild').val(null); sessionStorage.setItem('username',''); sessionStorage.setItem('roomiden',''); sessionStorage.setItem('listcell','');">
		<div class="wrapper">
			<nav class="main-header navbar navbar-expand navbar-lightblue navbar-dark">
				<ul class="navbar-nav">
					<li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a></li>
					<li class="nav-item d-none d-sm-inline-block"><a class="nav-link normelem"><i class="fas fa-clock"></i>&nbsp;<span id="timehead">TIMEHEAD</span></a></li>
				</ul>

				<form class="form-inline ml-3">
					<div class="input-group input-group-sm">
						<input class="form-control form-control-navbar" type="search" placeholder="Go to cell" aria-label="Search">
					</div>
				</form>

				<ul class="navbar-nav ml-auto">
					<li class="nav-item">
						<button class="btn btn-sm btn-light" style="margin-left: 5px; margin-right: 5px;" onclick="$('#openfild').val(null); $('#openmode').modal('show');">
							<span class="text-lightblue"><i class="fas fa-pen-nib"></i></span>
						</button>
					</li>
					<li class="nav-item">
						<button class="btn btn-sm btn-light" style="margin-left: 5px; margin-right: 5px;" onclick="SaveDocument();">
							<span class="text-lightblue"><i class="fas fa-save"></i></span>
						</button>
					</li>
					<li class="nav-item">
						<button class="btn btn-sm btn-light" style="margin-left: 5px; margin-right: 5px;" onclick="$('#abotmode').modal('show');">
							<span class="text-lightblue"><i class="fas fa-question"></i></span>
						</button>
					</li>
					<li class="nav-item">
						<button class="btn btn-sm btn-light" style="margin-left: 5px; margin-right: 5px;" onclick="$('#colbmode').modal('show');">
							<span class="text-lightblue"><i class="fas fa-wheelchair"></i></span>
						</button>
					</li>
					<li class="nav-item">
						<button class="btn btn-sm btn-light" style="margin-left: 5px; margin-right: 5px;" onclick="InsertCell();">
							<span class="text-lightblue"><i class="fas fa-plus"></i></span>
						</button>
					</li>
				</ul>
			</nav>

			<aside class="main-sidebar sidebar-dark-lightblue elevation-4" style="bottom: 0px;">
				<a href="#" class="brand-link bg-lightblue">
					<!--<img src="{{ url_for("static", filename="imgs/datalogo.svg") }}" alt="Syngrafias Logo" class="fas fa-tachometer brand-image img-circle elevation-3">-->
					<i alt="Syngrafias Logo" class="fas fa-tachometer"></i>
					<span class="brand-text headelem">Syngrafias</span>
				</a>

				<div class="sidebar">
					<nav class="mt-2">
						<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
							<li class="nav-item">
								<a href="#" class="nav-link normelem"><i class="fas fa-user nav-icon"></i><p id="userhead">Syngrafias</p></a>
							</li>
							<li class="nav-item">
								<a href="#" class="nav-link normelem"><i class="fas fa-tag nav-icon"></i><p id="idenhead">DEADCAFE</p></a>
							</li>
						</ul>
                        <hr style="margin-top: 10px; margin-bottom: 10px;" />
						<ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
							<li class="nav-item">
								<a href="#" class="nav-link normelem active"><i class="fas fa-tools nav-icon"></i><p>Build</p></a>
							</li>
							<li class="nav-item">
								<a onclick="$('#actimode').modal('show');" class="nav-link normelem"><i class="fas fa-clock nav-icon"></i><p>Activities</p></a>
							</li>
							<li class="nav-item">
								<a href="#" class="nav-link normelem"><i class="fas fa-cog nav-icon"></i><p>Settings</p></a>
							</li>
							<li class="nav-item">
								<a onclick="location.reload();" class="nav-link normelem"><i class="fas fa-sign-out-alt nav-icon"></i><p>Logout</p></a>
							</li>
						</ul>
                        <hr style="margin-top: 10px; margin-bottom: 10px;" />
					</nav>
				</div>
			</aside>

			<div class="content-wrapper" style="background-color: #ffffff;">
				<div class="content">
					<div class="container-fluid">
						<br/>
						<input class="form-control normelem" type="text" id="ttletext" placeholder="Enter the document title here">
						<br/>
						<ul id="sortable" style="list-style-type: none; margin: 0; padding: 0; width: 100%;"></ul>
					</div>
				</div>
			</div>

			<footer class="main-footer">
				<div class="float-right d-none d-sm-block">
					Created with <i class="fas fa-heart text-lightblue"></i> by <span class="headelem text-lightblue" onclick="window.location.href = 'https://github.com/t0xic0der/'">t0xic0der</span>
				</div>
				<span class="headelem text-lightblue">Syngrafias v26072020. </span><span onclick="window.location.href = 'https://github.com/t0xic0der/syngrafias/'" class="normelem">Contribute here.</span>
			</footer>
		</div>

        <div class="modal fade" id="givename" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-lightblue">
                        <h4 class="modal-title headelem">Syngrafias</h4>
                    </div>
                    <div class="modal-body">
						<p class="normelem">
							Syngrafias is a free and open-source synchronized authorship web-application for seamlessly collaborating on documents using intuitive cells.
						</p>
					 	<input type="text" id="username" placeholder="Enter your username" class="form-control normelem">
                        <br/>
                        <input type="text" id="roomiden" placeholder="Enter your workspace key" class="form-control normelem disabled">
                    </div>
                    <div class="modal-footer justify-content-between bg-lightblue">
                        <button type="button" class="btn btn-default" onclick="document.getElementById('roomiden').value = RandomStringGenerator();">Generate</button>
                        <button type="button" class="btn btn-default" onclick="SaveUserName()">Continue</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="openmode" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-lightblue">
                        <h4 class="modal-title headelem">Open an existing document</h4>
                    </div>
                    <div class="modal-body">
						<p class="normelem text-justify">
							The document that you open must be in the proper Syngrafias Workspace Document format. Also, keep in mind that opening a new document would replace the document that you are currently editing.
						</p>
						<p class="normelem text-justify">
							Browse for the file you want and then select it. Then, click on Open to load up the file. Once the file is parsed, you would be given an option to continue with the loaded document up for editing.
						</p>
						<div class="input-group">
							<div class="custom-file">
								<input type="file" class="custom-file-input" id="openfild" name="openfild">
								<label class="custom-file-label" for="openfild">Select a document to open</label>
							</div>
							<div class="input-group-append">
								<span class="input-group-text btn bg-lightblue" id="upldbutn">Open</span>
							</div>
						</div>
						<div id="readotpt"></div>
                    </div>
                    <div class="modal-footer justify-content-between bg-lightblue">
						<button type="button" class="btn btn-default" onclick="if (document.getElementById('fileinfo')) {document.getElementById('fileinfo').remove();} $('#openmode').modal('hide');">Exit</button>
                    </div>
                </div>
            </div>
        </div>

		<div class="modal fade" id="abotmode" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-lightblue">
                        <h4 class="modal-title headelem">About</h4>
                    </div>
                    <div class="modal-body">
                        <p class="normelem text-justify">Thank you for using Syngrafias!</p>
						<p class="normelem text-justify">
							Syngrafias was born to address the need of a perfect document editing platform which could be collaborative,
							synchronous and non-intrusive at the same time. So we picked the best features of available technologies (like
							Jupyter Notebook and Google Docs) and put them together to build this beauty.
						</p>
						<p>The following are the contributors to this project.</p>
                    	<ul class="users-list clearfix">
							<li>
								<img src="https://avatars0.githubusercontent.com/u/49605954?s=460&u=bd798cf7788f056e3c1a1a5bd2de5f4f5ae84eb9&v=4" alt="User Image">
								<a class="users-list-name" onclick="window.open('https://github.com/t0xic0der/', '_blank');">Akashdeep Dhar</a>
								<span class="users-list-date">t0xic0der</span>
							</li>
						</ul>
						<p>The following are the advisors to this project.</p>
						<ul class="users-list clearfix">
							<li>
								<img src="https://avatars0.githubusercontent.com/u/39235382?s=400&u=eeb07efa692bac0fcb441e4b054f80e66e73836b&v=4" alt="User Image">
								<a class="users-list-name" onclick="window.open('https://github.com/s-katte/', '_blank');">Shubham Katte</a>
								<span class="users-list-date">s-katte</span>
							</li>
							<li>
								<img src="https://avatars3.githubusercontent.com/u/32795689?s=460&u=2f970533be1f419b2804eaff81f02038626554aa&v=4" alt="User Image">
								<a class="users-list-name" onclick="window.open('https://github.com/VaibhavSaini19/', '_blank');">Vaibhav Saini</a>
								<span class="users-list-date">VaibhavSaini19</span>
							</li>
							<li>
								<img src="https://avatars2.githubusercontent.com/u/46623131?s=460&v=4" alt="User Image">
								<a class="users-list-name" onclick="window.open('https://github.com/mohitgurav/', '_blank');">Mohit Gurav</a>
								<span class="users-list-date">mohitgurav</span>
							</li>
                    	</ul>
					</div>
                    <div class="modal-footer justify-content-between bg-lightblue">
						<button type="button" class="btn btn-default" onclick="window.open('https://github.com/t0xic0der/syngrafias/', '_blank');">Fork</button>
                        <button type="button" class="btn btn-default" onclick="$('#abotmode').modal('hide');">Exit</button>
                    </div>
                </div>
            </div>
        </div>

		<div class="modal fade" id="sockfail" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-lightblue">
                        <h4 class="modal-title headelem">Connection failed</h4>
                    </div>
                    <div class="modal-body">
                        <p class="normelem text-justify" style="margin-bottom: 5px;">Any changes that you made could not be saved and conveyed as the connection to the WebSocket server could not be established. Please refresh the page and try again.</p>
                    </div>
                    <div class="modal-footer justify-content-between bg-lightblue">
                        <button type="button" class="btn btn-default" onclick="location.reload();">Refresh</button>
                    </div>
                </div>
            </div>
        </div>

		<div class="modal fade" id="actimode" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-lightblue">
                        <h4 class="modal-title headelem">Activities</h4>
                    </div>
                    <div class="modal-body">
                        <p class="normelem text-justify">These are the activities done so far.</p>
						<div class="table-responsive p-0" style="height: 450px;">
							<table id="proclist" class="table table-head-fixed text-nowrap table-sm">
								<thead><tr class="headelem"><th>#</th><th>Identity</th><th>Timestamp</th><th>Action</th></tr></thead>
								<tbody id="activity"></tbody>
							</table>
						</div>
                    </div>
                    <div class="modal-footer justify-content-between bg-lightblue">
						<button type="button" class="btn btn-default" onclick="$('tr.acticell').remove();">Wipe</button>
                        <button type="button" class="btn btn-default" onclick="$('#actimode').modal('hide');">Exit</button>
                    </div>
                </div>
            </div>
        </div>

		<div class="modal fade" id="colbmode" style="display: none;" aria-hidden="true" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-lightblue">
                        <h4 class="modal-title headelem">Instructions</h4>
                    </div>
                    <div class="modal-body">
                        <p class="headelem text-justify">For smooth and hassle-free collaboration while creating documents, you would want to follow the given instructions.</p>
						<ul style="padding-left: 15px;">
							<li class="normelem text-justify">You would want to begin making changes to the document only afer all collaborators have joined. Any change made in their absence (That is if you edit the document before all the collaborators join or continue editing after they leave), those changes would not be made in their copies.</li>
							<li class="normelem text-justify">Your fellow collaborators can join only when they open up a copy of the same document at their end too. So be doubly sure to save your work at all the ends before logging out of the workspace because they will be opening up the very same file at their ends when editing again together.</li>
							<li class="normelem text-justify">Be sure to stay connected at all the times while making changes to keep them synchronized at all the ends. You would automatically be thrown an error should you get disconnected from the WebSocket server and you would not be able to make any changes until you refresh the page.</li>
							<li class="normelem text-justify">Your session details are limited only to your current tab so closing the tab or refreshing the page would automatically log you out from your current workspace. Be sure to log back into the same workspace and open your copy of the file to continue editing collaboratively.</li>
							<li class="normelem text-justify">Even if you are not actively collaborating in the edits, you can keep up with the changes made so far by simply staying connected to the workspace while the changes are made (active sync) or by taking a copy from one of the fellow contributors after changes are complete (passive sync).</li>
						</ul>
                    </div>
                    <div class="modal-footer justify-content-between bg-lightblue">
                        <button type="button" class="btn btn-default" onclick="$('#colbmode').modal('hide');">Exit</button>
                    </div>
                </div>
            </div>
        </div>

    </body>

	<script type="text/javascript">
		$(document).ready(function () {
			bsCustomFileInput.init();
		});
		let fileinpt = $("#openfild");
		let upldbutn = $("#upldbutn");
		upldbutn.on("click", function () {
			if (!window.FileReader)
			{
				toastr.error("The file could not be read due to unavailability of file reader API.", "", {"positionClass": "toast-bottom-right"});
			}
			else
			{
				let textinpt = fileinpt.get(0);
				let readobjc = new FileReader();
				if (textinpt.files.length)
				{
					let textfile = textinpt.files[0];
					readobjc.readAsText(textfile);
					$(readobjc).on("load", ProcessFile);
				}
				else
				{
					toastr.error("Please upload a file before continuing to open it.", "", {"positionClass": "toast-bottom-right"});
				}
			}
		});
	</script>
	<script type="text/javascript">
		$(function() {
    		$("#sortable").sortable();
    		//$("#sortable").disableSelection();
  		});
	</script>
	<script>
		let webesock = new WebSocket("ws://" + document.domain + ":" + {{ sockport }} + "/");
		console.log("WebSocket is supposed to be at ws://" + document.domain + ":{{ sockport }}/");
		function StartRunningTime()
		{
			let curtdate = new Date();
			let hour = curtdate.getHours(); let mint = curtdate.getMinutes(); let secs = curtdate.getSeconds();
			hour = CheckTiming(hour); mint = CheckTiming(mint); secs = CheckTiming(secs);
			document.getElementById("timehead").innerHTML = hour + ":" + mint + ":" + secs;
			let time = setTimeout(StartRunningTime, 500);
		}
		function RandomStringGenerator()
		{
			let randstng = "";
			let lent = 8; let list = "0123456789abcdef";
			for (let indx = lent; indx > 0; indx--)
			{
				randstng += list[Math.floor(Math.random() * list.length)];
			}
			return randstng;
		}
		function SaveUserName() {
			let username = document.getElementById("username").value;
			let roomiden = document.getElementById("roomiden").value;
			if (username != "" && roomiden != "")
			{
				if (!(/\s/.test(username) || /\s/.test(roomiden)))
				{
					if (roomiden.match(/^[a-f0-9]{8}$/) && username.match(/^[a-z0-9]+$/))
					{
						sessionStorage.setItem("username", username); sessionStorage.setItem("roomiden", roomiden);
						$('#givename').modal('hide');
						document.getElementById("username").value = ""; document.getElementById("roomiden").value = "";
						document.getElementById("userhead").innerText = username; document.getElementById("idenhead").innerText = roomiden;
						sessionStorage.setItem("listcell","");
					}
					else
					{
						toastr.error("Please rectify your input in either username or workspace key fields before continuing.","",{"positionClass": "toast-bottom-right"});
					}
				}
				else
				{
					toastr.error("Please rectify your input in either username or workspace key fields before continuing.","",{"positionClass": "toast-bottom-right"});
				}
			}
		}
		function CheckTiming(chekqant)
        {
            if (chekqant < 10)
                return "0"+chekqant;
            else
                return chekqant;
        }
        function SaveDocument()
		{
			$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
			if (sessionStorage.getItem("listcell").trim() != "")
			{
				let listcell = sessionStorage.getItem("listcell").split(", ");
				let printarr = [];
				for (let indx = 0; indx < listcell.length; indx++)
				{
					if (listcell[indx] != "")
					{
						console.log(listcell[indx]);
						let arryelem = {
							celliden: listcell[indx],
							cellname: document.getElementById("cellname-"+listcell[indx]).value,
							conttext: $("#conttext-"+listcell[indx]).summernote("code")
						};
						printarr.push(arryelem);
					}
				}
				console.log(printarr);
				printstr = JSON.stringify(printarr);
				$.getJSON($SCRIPT_ROOT + "/savedocs/", {
						username: sessionStorage.getItem("username"),
						workspec: sessionStorage.getItem("roomiden"),
						docsname: document.getElementById("ttletext").value,
						document: printstr
					}, function(data) {
						console.log(data.result);
						if (data.result == "fail")
						{
							toastr.error("The document could not be saved due to an internal server error.","",{"positionClass": "toast-bottom-right"});
						}
						else
						{
							toastr.success("The document was saved successfully.","",{"positionClass": "toast-bottom-right"});
							window.open("static/docs/"+data.result.toString(), "_blank");
						}
					}
				);
			}
			else
			{
				toastr.error("The document could not be saved as it is empty.","",{"positionClass": "toast-bottom-right"});
			}
		}
		function ProcessFile(e)
		{
			let actifile = e.target.result;
			if (actifile && actifile.length) {
				//console.log(actifile);
				try {
					let document = JSON.parse(actifile);
					let modifdom = "<div id='fileinfo'>" + "<br/>" + "<dl class='row'>" +
						"<dt class='col-sm-4'>Workspace ID</dt>" +
						"<dd class='col-sm-8'>" + document["workspec"] + "</dd>" +
						"<dt class='col-sm-4'>Created by</dt>" +
						"<dd class='col-sm-8'>" + document["username"] + "</dd>" +
						"<dt class='col-sm-4'>Last modified on</dt>" +
						"<dd class='col-sm-8'>" + document["maketime"] + "</dd>" +
						"</dl>" + "<button type='button' class='btn bg-lightblue' onclick=' OpenDocument(" + actifile + ");'>Continue with this document</button>" + "</div>";
					$("#readotpt").html(modifdom);
				}
				catch (e) {
					toastr.error("The file could not be opened as the format is unrecognizable.","",{"positionClass": "toast-bottom-right"});
					if (document.getElementById("fileinfo"))
					{
						document.getElementById("fileinfo").remove();
					}
				}
			}
		}
		function OpenDocument(actifile)
		{
			if (document.getElementById("fileinfo"))
			{
				document.getElementById("fileinfo").remove();
			}
			$("#openmode").modal("hide");
			$("#colbmode").modal("show");
			console.log(actifile);
			let listcell = sessionStorage.getItem("listcell").split(", ");
			for (let indx = 0; indx < listcell.length; indx++)
			{
				let celliden = listcell[indx];
				if (celliden != "")
				{
					document.getElementById(celliden).remove();
					let listcell = sessionStorage.getItem("listcell");
					listcell = listcell.replace(celliden + ", ", "");
					sessionStorage.setItem("listcell", listcell);
					console.log("Deleted a cell : " + listcell);
					let curtdate = new Date;
				}
			}
			toastr.error("All cells of the document were removed in order to open up a new document.","",{"positionClass": "toast-bottom-right"});
			console.log(sessionStorage.getItem("listcell"));
			listcell = "";
			for (let indx = 0; indx < actifile["document"].length; indx++)
			{
				listcell = listcell + actifile["document"][indx]["celliden"] + ", ";
			}
			sessionStorage.setItem("listcell",listcell);

			/*
			console.log(sessionStorage.getItem("listcell"));
			console.log(sessionStorage.getItem("listcell"));
			*/
			listcell = sessionStorage.getItem("listcell").split(", ");
			for (let indx = 0; indx < listcell.length; indx++)
			{
				let celliden = listcell[indx];
				if (celliden != "")
				{
					let modifdom = "<li class='' id='" + celliden + "'>" + "<div class='callout callout-info'>" + "<div class='input-group mb-3'>" +
						"<div class='input-group-prepend'>" + "<span class='input-group-text bg-lightblue' id='celliden-" + celliden + "' >" + celliden.toUpperCase() + "</span>" +
						"</div>" + "<input type='text' class='form-control' id='cellname-" + celliden + "' placeholder='Enter the cell name here'>" +
						"<div class='input-group-append'>" + "<span class='input-group-text bg-danger' onclick='DeleteCell(\"" + celliden + "\")'><i class='fas fa-times'></i></span>" +
						"</div>" + "</div>" + "<div id='conttext-" + celliden + "'></div>" + "</div>" + "</li>";
					$("#sortable").append(modifdom);
					document.getElementById("cellname-"+celliden).value = actifile["document"][indx]["cellname"];
					$("#conttext-"+celliden).summernote({
						tabsize: 4,
						height: "100",
						toolbar: [
							["style", ["bold", "italic", "underline", "clear"]],
							["font", ["strikethrough", "superscript", "subscript"]],
							["fontsize", ["fontsize"]],
							["color", ["color"]],
							["para", ["ul", "ol", "paragraph"]],
							["height", ["height"]],
						],
						callbacks: {
							onKeydown: function (e) {
								let contents = $("#conttext-"+celliden).summernote("code");
								let writings = "/note " + celliden + " " + contents;
								let curtdate = new Date;
								webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
								let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
									"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
									"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
									"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
								$("#activity").append(modifdom);
							},
							onKeyup: function (e) {
								let contents = $("#conttext-"+celliden).summernote("code");
								let writings = "/note " + celliden + " " + contents;
								let curtdate = new Date;
								webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
								let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
									"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
									"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
									"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
								$("#activity").append(modifdom);
							},
							onPaste: function (e) {
								let contents = $("#conttext-"+celliden).summernote("code");
								let writings = "/note " + celliden + " " + contents;
								let curtdate = new Date;
								webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
								let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
									"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
									"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
									"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
								$("#activity").append(modifdom);
							}
						}
					});
					$("#conttext-"+celliden).summernote("code", actifile["document"][indx]["conttext"]);
				}
			}
			toastr.success("All cells were successfully loaded from the opened file.","",{"positionClass": "toast-bottom-right"});
		}
	  	function InsertCell()
		{
			if (webesock.readyState == 3)
			{
				$("#sockfail").modal("show");
			}
			else
			{
			    let curtdate = new Date();
				let celliden = RandomStringGenerator();
				let modifdom = "<li class='' id='" + celliden + "'>" + "<div class='callout callout-info'>" + "<div class='input-group mb-3'>" +
					"<div class='input-group-prepend'>" + "<span class='input-group-text bg-lightblue' id='celliden-" + celliden + "' >" + celliden.toUpperCase() + "</span>" +
					"</div>" + "<input type='text' class='form-control' id='cellname-" + celliden + "' placeholder='Enter the cell name here'>" +
					"<div class='input-group-append'>" + "<span class='input-group-text bg-danger' onclick='DeleteCell(\"" + celliden + "\")'><i class='fas fa-times'></i></span>" +
					"</div>" + "</div>" + "<div id='conttext-" + celliden + "'></div>" + "</div>" + "</li>";
				$("#sortable").append(modifdom);
				modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-plus text-success'></i></td>" +
					"<td><code class='text-success'>" + celliden.toUpperCase() + "</code></td>" +
					"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
					"<td><span class='headelem'>You</span> created a cell.</td></tr>";
				$("#activity").append(modifdom);
				$("#conttext-"+celliden).summernote({
					tabsize: 4,
					height: "100",
					toolbar: [
						["style", ["bold", "italic", "underline", "clear"]],
						["font", ["strikethrough", "superscript", "subscript"]],
						["fontsize", ["fontsize"]],
						["color", ["color"]],
						["para", ["ul", "ol", "paragraph"]],
						["height", ["height"]],
                    ],
					focus: true,
					callbacks: {
						onKeydown: function (e) {
							let contents = $("#conttext-"+celliden).summernote("code");
							let writings = "/note " + celliden + " " + contents;
							let curtdate = new Date;
							webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
							let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
								"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
								"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
								"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
                        	$("#activity").append(modifdom);
						},
						onKeyup: function (e) {
							let contents = $("#conttext-"+celliden).summernote("code");
							let writings = "/note " + celliden + " " + contents;
							let curtdate = new Date;
							webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
							let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
								"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
								"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
								"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
                        	$("#activity").append(modifdom);
						},
						onPaste: function (e) {
							let contents = $("#conttext-"+celliden).summernote("code");
							let writings = "/note " + celliden + " " + contents;
							let curtdate = new Date;
							webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
							let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
								"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
								"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
								"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
                        	$("#activity").append(modifdom);
						}
					}
				});
				let listcell = sessionStorage.getItem("listcell");
				listcell = listcell + celliden + ", ";
				sessionStorage.setItem("listcell", listcell);
				console.log("Inserted a cell : " + listcell);
				webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg:"/make " + celliden}));
				toastr.success("A cell named <span class='headelem'>" + celliden.toUpperCase() + "</span> was successfully created from your end and conveyed to all collaborators.","",{"positionClass": "toast-bottom-right"});
			}
		}
		function DeleteCell(celliden)
		{
			if (webesock.readyState == 3)
			{
				$("#sockfail").modal("show");
			}
			else
			{
				document.getElementById(celliden).remove();
				let listcell = sessionStorage.getItem("listcell");
				listcell = listcell.replace(celliden + ", ", "");
				sessionStorage.setItem("listcell", listcell);
				console.log("Deleted a cell : " + listcell);
				let curtdate = new Date;
				let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-times text-danger'></i></td>" +
					"<td><code class='text-danger'>" + celliden.toUpperCase() + "</code></td>" +
					"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
					"<td><span class='headelem'>You</span> removed a cell.</td></tr>";
				$("#activity").append(modifdom);
				webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg:"/wipe " + celliden}));
				toastr.error("A cell named <span class='headelem'>" + celliden.toUpperCase() + "</span> was successfully deleted from your end and conveyed to all collaborators.","",{"positionClass": "toast-bottom-right"});
			}
		}
		webesock.onmessage = function (event)
		{
			let data = JSON.parse(event.data);
			if (!(data.username == sessionStorage.getItem("username")))
			{
				if (data.roomiden == sessionStorage.getItem("roomiden"))
				{
					if (data.textmesg.split(" ")[0] == "/make")
					{
					    let curtdate = new Date;
						let celliden = data.textmesg.split(" ")[1];
						let modifdom = "<li class='' id='" + celliden + "'>" + "<div class='callout callout-info'>" + "<div class='input-group mb-3'>" +
							"<div class='input-group-prepend'>" + "<span class='input-group-text bg-lightblue' id='celliden-" + celliden + "' >" + celliden.toUpperCase() + "</span>" +
							"</div>" + "<input type='text' class='form-control' id='cellname-" + celliden + "' placeholder='Enter the cell name here'>" +
							"<div class='input-group-append'>" + "<span class='input-group-text bg-danger' onclick='DeleteCell(\"" + celliden + "\")'><i class='fas fa-times'></i></span>" +
							"</div>" + "</div>" + "<div id='conttext-" + celliden + "'></div>" + "</div>" + "</li>";
						$("#sortable").append(modifdom);
						modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-plus-circle text-success'></i></td>" +
							"<td><code class='text-success'>" + celliden.toUpperCase() + "</code></td>" +
							"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
							"<td><span class='headelem'>" + data.username + "</span> created a cell.</td></tr>";
                        $("#activity").append(modifdom);
						$("#conttext-"+celliden).summernote({
							tabsize: 4,
							height: "100",
							toolbar: [
								["style", ["bold", "italic", "underline", "clear"]],
								["font", ["strikethrough", "superscript", "subscript"]],
								["fontsize", ["fontsize"]],
								["color", ["color"]],
								["para", ["ul", "ol", "paragraph"]],
								["height", ["height"]]
							],
                            callbacks: {
                                onKeydown: function (e) {
                                	let contents = $("#conttext-"+celliden).summernote("code");
                                    let writings = "/note " + celliden + " " + contents;
                                    let curtdate = new Date;
                                    webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
									let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
										"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
										"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
										"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
									$("#activity").append(modifdom);
                                },
                                onKeyup: function (e) {
                                	let contents = $("#conttext-"+celliden).summernote("code");
                                    let writings = "/note " + celliden + " " + contents;
                                    let curtdate = new Date;
                                    webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
									let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
										"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
										"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
										"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
									$("#activity").append(modifdom);
                                },
                                onPaste: function (e) {
                                	let contents = $("#conttext-"+celliden).summernote("code");
                                    let writings = "/note " + celliden + " " + contents;
                                    let curtdate = new Date;
                                    webesock.send(JSON.stringify({username: sessionStorage.getItem("username"), roomiden: sessionStorage.getItem("roomiden"), textmesg: writings}));
									let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus text-info'></i></td>" +
										"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
										"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
										"<td><span class='headelem'>You</span> wrote to a cell.</td></tr>";
									$("#activity").append(modifdom);
                                }
                            }
						});
						let listcell = sessionStorage.getItem("listcell");
						listcell = listcell + celliden + ", ";
						sessionStorage.setItem("listcell", listcell);
						console.log("Received a cell creation call : " + listcell);
						toastr.success("The creation of a cell named <span class='headelem'>" + celliden.toUpperCase() + "</span> was conveyed to all collaborators by <span class='headelem'>" + data.username + "</span>.","",{"positionClass": "toast-bottom-right"});
					}
					else if (data.textmesg.split(" ")[0] == "/wipe")
					{
						let celliden = data.textmesg.split(" ")[1];
						if (sessionStorage.getItem("listcell").includes(celliden) == true)
						{
							document.getElementById(celliden).remove();
							let listcell = sessionStorage.getItem("listcell");
							listcell = listcell.replace(celliden + ", ", "");
							sessionStorage.setItem("listcell", listcell);
							console.log("Received a cell deletion call : " + listcell);
							let curtdate = new Date;
							let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-times-circle text-danger'></i></td>" +
								"<td><code class='text-danger'>" + celliden.toUpperCase() + "</code></td>" +
								"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
								"<td><span class='headelem'>" + data.username + "</span> removed a cell.</td></tr>";
							$("#activity").append(modifdom);
							toastr.error("The deletion of a cell named <span class='headelem'>" + celliden.toUpperCase() + "</span> was conveyed to all collaborators by <span class='headelem'>" + data.username + "</span>.","",{"positionClass": "toast-bottom-right"});
						}
						else
						{
							toastr.error("The deletion of a cell named <span class='headelem'>" + celliden.toUpperCase() + "</span> was conveyed to all collaborators by <span class='headelem'>" + data.username + "</span>. The instruction could not be followed as the cell does not exist at your end.","",{"positionClass": "toast-bottom-right"});
						}
					}
					else if (data.textmesg.split(" ")[0] == "/note")
                    {
                        let celliden = data.textmesg.split(" ")[1];
                        let textmesg = data.textmesg.replace(celliden, "");
                        textmesg = textmesg.replace("/note", "");
                        textmesg = textmesg.trim();
						let curtdate = new Date;
                        $("#conttext-"+celliden).summernote("code", textmesg);
						let modifdom = "<tr class='normelem acticell'>" + "<td><i class='fas fa-minus-circle text-info'></i></td>" +
							"<td><code class='text-info'>" + celliden.toUpperCase() + "</code></td>" +
							"<td>" + CheckTiming(curtdate.getHours()) + ":" + CheckTiming(curtdate.getMinutes()) + ":" + CheckTiming(curtdate.getSeconds()) + "</td>" +
							"<td><span class='headelem'>" + data.username + "</span> wrote to a cell.</td></tr>";
                        $("#activity").append(modifdom);
                    }
				}
			}
		}
	</script>
</html>
